{% extends "base.html" %}

{% block title %}Book History - NoteFlow AI{% endblock %}

{% block content %}
<div class="result-section">
    <h2>
        <span>ğŸ“š</span>
        <span>Book Summary History</span>
    </h2>

    {% if books %}
        <div class="meeting-grid">
            {% for book in books %}
            <div class="meeting-card" onclick="showBookModal({{ book.id }})">
                <h3>ğŸ“– {{ book.title or "Untitled Book" }}</h3>
                <div class="date">
                    <span>ğŸ“…</span>
                    {{ book.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                </div>
                <div class="preview" style="font-size: 0.85em; color: #666; margin: 8px 0;">
                    {{ book.file_type.upper() }} file
                </div>
                {% if book.summary %}
                <div class="preview">
                    {{ book.summary[:150] }}{% if book.summary|length > 150 %}...{% endif %}
                </div>
                {% endif %}
                <button class="btn" style="text-decoration: none; width: 100%;" onclick="event.stopPropagation(); showBookModal({{ book.id }})">
                    <span>ğŸ‘</span>
                    <span>View Summary</span>
                </button>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ“š</div>
            <p style="font-size: 1.2rem; margin-bottom: 12px;">No book summaries yet</p>
            <p style="margin-bottom: 24px;">Upload your first book to get started</p>
            <a href="/books" class="btn" style="text-decoration: none;">
                <span>ğŸ“–</span>
                <span>Upload Book</span>
            </a>
        </div>
    {% endif %}

    <div class="action-buttons">
        <a href="/books" class="btn" style="text-decoration: none;">
            <span>â¬†</span>
            <span>Upload New Book</span>
        </a>
        <a href="/" class="btn btn-secondary" style="text-decoration: none;">
            <span>ğŸ¤</span>
            <span>Voice Notes</span>
        </a>
    </div>
</div>

<!-- Book Result Modal -->
<div id="bookModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>
                <span>ğŸ“š</span>
                <span>Book Summary</span>
            </h2>
            <button class="modal-close" id="closeBookModal">
                <span>&times;</span>
            </button>
        </div>

        <div class="modal-body">
            <div class="notes">
                <h3 id="bookTitle">Book Title</h3>
            </div>

            <div class="notes">
                <div class="summary-header">
                    <h3>âœ¨ AI-Generated Summary</h3>
                    <div class="translate-controls">
                        <select id="modalTargetLanguage" class="language-select-inline" onchange="translateBookSummary()">
                            <option value="">ğŸŒ Translate</option>
                            <option value="Spanish">ğŸ‡ªğŸ‡¸ Spanish</option>
                            <option value="French">ğŸ‡«ğŸ‡· French</option>
                            <option value="German">ğŸ‡©ğŸ‡ª German</option>
                            <option value="Arabic">ğŸ‡¸ğŸ‡¦ Arabic</option>
                            <option value="Chinese">ğŸ‡¨ğŸ‡³ Chinese</option>
                            <option value="Japanese">ğŸ‡¯ğŸ‡µ Japanese</option>
                            <option value="Korean">ğŸ‡°ğŸ‡· Korean</option>
                            <option value="Portuguese">ğŸ‡µğŸ‡¹ Portuguese</option>
                            <option value="Russian">ğŸ‡·ğŸ‡º Russian</option>
                            <option value="Italian">ğŸ‡®ğŸ‡¹ Italian</option>
                            <option value="Hindi">ğŸ‡®ğŸ‡³ Hindi</option>
                            <option value="Turkish">ğŸ‡¹ğŸ‡· Turkish</option>
                        </select>
                    </div>
                </div>
                <div id="modalSummary"></div>
            </div>

            <!-- Export Options -->
            <div class="export-options">
                <button class="btn btn-export export-btn" onclick="exportBookAsText()" title="Download summary as a plain text file">
                    <span>ğŸ“¥</span>
                    <span>Export as TXT</span>
                </button>
                <button class="btn btn-export export-btn" onclick="exportBookAsMarkdown()" title="Download summary as a Markdown file">
                    <span>ğŸ“„</span>
                    <span>Export as Markdown</span>
                </button>
                <button class="btn btn-secondary export-btn" onclick="copyBookToClipboard()" title="Copy summary to your clipboard">
                    <span>ğŸ“‹</span>
                    <span>Copy to Clipboard</span>
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn" onclick="closeBookModal()">
                    <span>âœ–</span>
                    <span>Close</span>
                </button>
                <a href="/books" class="btn btn-secondary">
                    <span>ğŸ“–</span>
                    <span>Upload Another Book</span>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Modal Functions
let currentBookData = null;
let originalBookSummary = null;

function showBookModal(bookId) {
    fetch(`/api/book/${bookId}`)
        .then(response => response.json())
        .then(data => {
            currentBookData = data;

            document.getElementById('bookTitle').textContent = data.title || 'Untitled Book';
            document.getElementById('modalSummary').textContent = data.summary || 'Summary not available';

            originalBookSummary = data.summary || 'Summary not available';
            document.getElementById('modalTargetLanguage').value = '';

            const modal = document.getElementById('bookModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        })
        .catch(error => {
            console.error('Error fetching book:', error);
            showToast('Error', 'Failed to load book data', 'error');
        });
}

function closeBookModal() {
    const modal = document.getElementById('bookModal');
    modal.classList.remove('show');
    document.body.style.overflow = 'auto';
    currentBookData = null;
}

// Translation
async function translateBookSummary() {
    const select = document.getElementById('modalTargetLanguage');
    const targetLanguage = select.value;
    const summaryContent = document.getElementById('modalSummary');

    if (!targetLanguage) {
        if (originalBookSummary) {
            summaryContent.textContent = originalBookSummary;
        }
        return;
    }

    const textToTranslate = originalBookSummary || summaryContent.textContent;

    try {
        const originalContent = summaryContent.textContent;
        summaryContent.textContent = 'â³ Translating to ' + targetLanguage + '...';

        const response = await fetch('/api/translate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text: textToTranslate,
                language: targetLanguage
            })
        });

        const data = await response.json();

        if (data.success) {
            summaryContent.textContent = data.translated_text;
            showToast('Translation Complete', `Translated to ${targetLanguage}`, 'success');
        } else {
            summaryContent.textContent = originalContent;
            showToast('Translation Failed', data.message, 'error');
            select.value = '';
        }
    } catch (error) {
        console.error('Translation error:', error);
        summaryContent.textContent = originalBookSummary || 'Translation failed';
        showToast('Translation Failed', 'An error occurred during translation', 'error');
        select.value = '';
    }
}

// Export Functions
function exportBookAsText() {
    if (!currentBookData) return;

    // Get the currently displayed summary (which may be translated)
    const displayedSummary = document.getElementById('modalSummary').textContent;
    const content = `BOOK: ${currentBookData.title}\n\n\nSUMMARY:\n\n${displayedSummary}`;

    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `book-summary-${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showToast('Export Complete', 'File downloaded successfully', 'success', 3000);
}

function exportBookAsMarkdown() {
    if (!currentBookData) return;

    // Get the currently displayed summary (which may be translated)
    const displayedSummary = document.getElementById('modalSummary').textContent;
    const content = `# ${currentBookData.title}\n\n## Summary\n\n${displayedSummary}`;

    const blob = new Blob([content], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `book-summary-${Date.now()}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showToast('Export Complete', 'File downloaded successfully', 'success', 3000);
}

function copyBookToClipboard() {
    if (!currentBookData) return;

    // Get the currently displayed summary (which may be translated)
    const displayedSummary = document.getElementById('modalSummary').textContent;
    const content = `BOOK: ${currentBookData.title}\n\n\nSUMMARY:\n\n${displayedSummary}`;

    navigator.clipboard.writeText(content).then(() => {
        showToast('Copied', 'Book summary copied to clipboard', 'success', 2000);
    }).catch(err => {
        console.error('Copy failed:', err);
        showToast('Copy Failed', 'Failed to copy to clipboard', 'error');
    });
}

// Close modal functionality
document.addEventListener('DOMContentLoaded', function() {
    const closeModalBtn = document.getElementById('closeBookModal');
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeBookModal);
    }

    const modal = document.getElementById('bookModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeBookModal();
            }
        });
    }
});
</script>
{% endblock %}
