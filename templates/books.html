{% extends "base.html" %}

{% block title %}Book Summarizer - NoteFlow AI{% endblock %}

{% block content %}
<div class="upload-section">
    <h2>ğŸ“š Summarize Your Books</h2>
    <p>Upload PDF, EPUB, TXT, or DOCX files and get AI-powered summaries</p>

    <form id="uploadBookForm" method="POST" action="/books/upload" enctype="multipart/form-data">
        <!-- Upload Section -->
        <div class="upload-column" style="max-width: 600px; margin: 0 auto;">
            <div class="drop-zone" id="dropZoneBook">
                <div class="drop-zone-icon">ğŸ“–</div>
                <div class="drop-zone-text">Drag & drop your book file</div>
                <div class="drop-zone-hint">or click to browse</div>
                <div class="drop-zone-hint" style="margin-top: 10px; font-size: 0.9em;">
                    Supported: PDF, EPUB, TXT, DOCX
                </div>
                <input type="file" id="bookFile" name="book" accept=".pdf,.epub,.txt,.docx,.doc" class="file-input">
            </div>
        </div>

        <div id="fileSelected" class="file-selected">
            <span id="fileName"></span>
        </div>

        <button type="submit" class="btn" id="submitBtn" disabled>
            <span>ğŸ“</span>
            <span>Summarize Book</span>
        </button>
    </form>
</div>

<div class="container" style="margin-top: 40px; text-align: center;">
    <a href="/" class="btn btn-secondary" style="text-decoration: none;">
        <span>ğŸ¤</span>
        <span>Voice Notes</span>
    </a>
</div>

<!-- Result Modal -->
<div id="resultModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>
                <span>ğŸ“š</span>
                <span>Book Summary</span>
            </h2>
            <button class="modal-close" id="closeModal">
                <span>&times;</span>
            </button>
        </div>

        <div class="modal-body">
            <div class="notes">
                <h3 id="bookTitle">Book Title</h3>
            </div>

            <div class="notes">
                <div class="summary-header">
                    <h3>âœ¨ AI-Generated Summary</h3>
                    <div class="translate-controls">
                        <select id="modalTargetLanguage" class="language-select-inline" onchange="translateBookSummary()">
                            <option value="">ğŸŒ Translate</option>
                            <option value="Spanish">ğŸ‡ªğŸ‡¸ Spanish</option>
                            <option value="French">ğŸ‡«ğŸ‡· French</option>
                            <option value="German">ğŸ‡©ğŸ‡ª German</option>
                            <option value="Arabic">ğŸ‡¸ğŸ‡¦ Arabic</option>
                            <option value="Chinese">ğŸ‡¨ğŸ‡³ Chinese</option>
                            <option value="Japanese">ğŸ‡¯ğŸ‡µ Japanese</option>
                            <option value="Korean">ğŸ‡°ğŸ‡· Korean</option>
                            <option value="Portuguese">ğŸ‡µğŸ‡¹ Portuguese</option>
                            <option value="Russian">ğŸ‡·ğŸ‡º Russian</option>
                            <option value="Italian">ğŸ‡®ğŸ‡¹ Italian</option>
                            <option value="Hindi">ğŸ‡®ğŸ‡³ Hindi</option>
                            <option value="Turkish">ğŸ‡¹ğŸ‡· Turkish</option>
                        </select>
                    </div>
                </div>
                <div id="modalSummary"></div>
            </div>

            <!-- Export Options -->
            <div class="export-options">
                <button class="btn btn-export export-btn" onclick="exportBookAsText()" title="Download summary as a plain text file">
                    <span>ğŸ“¥</span>
                    <span>Export as TXT</span>
                </button>
                <button class="btn btn-export export-btn" onclick="exportBookAsMarkdown()" title="Download summary as a Markdown file">
                    <span>ğŸ“„</span>
                    <span>Export as Markdown</span>
                </button>
                <button class="btn btn-secondary export-btn" onclick="copyBookToClipboard()" title="Copy summary to your clipboard">
                    <span>ğŸ“‹</span>
                    <span>Copy to Clipboard</span>
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn" onclick="closeResultModal()">
                    <span>â¬†</span>
                    <span>Upload Another Book</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('bookFile');
    const uploadForm = document.getElementById('uploadBookForm');
    const dropZone = document.getElementById('dropZoneBook');
    const fileSelected = document.getElementById('fileSelected');
    const fileName = document.getElementById('fileName');
    const submitBtn = document.getElementById('submitBtn');

    // Drag and Drop Functionality
    if (dropZone && fileInput) {
        dropZone.addEventListener('click', function() {
            fileInput.click();
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, function() {
                dropZone.classList.add('dragover');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, function() {
                dropZone.classList.remove('dragover');
            });
        });

        dropZone.addEventListener('drop', function(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFileSelect(this.files[0]);
            }
        });
    }

    function handleFileSelect(file) {
        if (!file) return;

        const fileExtension = file.name.split('.').pop().toLowerCase();
        const allowedExtensions = ['pdf', 'epub', 'txt', 'docx', 'doc'];

        if (!allowedExtensions.includes(fileExtension)) {
            showToast('Invalid File Type', 'Please select a valid book file: PDF, EPUB, TXT, or DOCX', 'error');
            fileInput.value = '';
            return;
        }

        fileName.textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
        fileSelected.style.display = 'block';
        submitBtn.disabled = false;
        showToast('File Selected', `${file.name} is ready to process`, 'success', 3000);
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Form submission
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();

            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('No File Selected', 'Please select a book file first', 'warning');
                return;
            }

            const formData = new FormData(uploadForm);

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="btn-spinner"></span><span>Processing...</span>';

            fetch('/books/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showResultModal(data.book_id);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span>ğŸ“</span><span>Summarize Book</span>';
                    uploadForm.reset();
                    fileSelected.style.display = 'none';
                } else {
                    throw new Error(data.message || 'Processing failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Processing Failed', error.message || 'An error occurred', 'error', 7000);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>ğŸ“</span><span>Summarize Book</span>';
            });
        });
    }

    // Modal close functionality
    const closeModalBtn = document.getElementById('closeModal');
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeResultModal);
    }

    const modal = document.getElementById('resultModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeResultModal();
            }
        });
    }
});

// Modal Functions
let currentBookData = null;
let originalBookSummary = null;

function showResultModal(bookId) {
    fetch(`/api/book/${bookId}`)
        .then(response => response.json())
        .then(data => {
            currentBookData = data;

            document.getElementById('bookTitle').textContent = data.title || 'Untitled Book';
            document.getElementById('modalSummary').textContent = data.summary || 'Summary not available';

            originalBookSummary = data.summary || 'Summary not available';
            document.getElementById('modalTargetLanguage').value = '';

            const modal = document.getElementById('resultModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            showToast('Success', 'Your book summary is ready!', 'success', 3000);
        })
        .catch(error => {
            console.error('Error fetching book:', error);
            showToast('Error', 'Failed to load book data', 'error');
        });
}

function closeResultModal() {
    const modal = document.getElementById('resultModal');
    modal.classList.remove('show');
    document.body.style.overflow = 'auto';
    currentBookData = null;
}

// Translation
async function translateBookSummary() {
    const select = document.getElementById('modalTargetLanguage');
    const targetLanguage = select.value;
    const summaryContent = document.getElementById('modalSummary');

    if (!targetLanguage) {
        if (originalBookSummary) {
            summaryContent.textContent = originalBookSummary;
        }
        return;
    }

    const textToTranslate = originalBookSummary || summaryContent.textContent;

    try {
        const originalContent = summaryContent.textContent;
        summaryContent.textContent = 'â³ Translating to ' + targetLanguage + '...';

        const response = await fetch('/api/translate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text: textToTranslate,
                language: targetLanguage
            })
        });

        const data = await response.json();

        if (data.success) {
            summaryContent.textContent = data.translated_text;
            showToast('Translation Complete', `Translated to ${targetLanguage}`, 'success');
        } else {
            summaryContent.textContent = originalContent;
            showToast('Translation Failed', data.message, 'error');
            select.value = '';
        }
    } catch (error) {
        console.error('Translation error:', error);
        summaryContent.textContent = originalBookSummary || 'Translation failed';
        showToast('Translation Failed', 'An error occurred during translation', 'error');
        select.value = '';
    }
}

// Export Functions
function exportBookAsText() {
    if (!currentBookData) return;

    const content = `BOOK: ${currentBookData.title}\n\n\nSUMMARY:\n\n${currentBookData.summary}`;

    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `book-summary-${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showToast('Export Complete', 'File downloaded successfully', 'success', 3000);
}

function exportBookAsMarkdown() {
    if (!currentBookData) return;

    const content = `# ${currentBookData.title}\n\n## Summary\n\n${currentBookData.summary}`;

    const blob = new Blob([content], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `book-summary-${Date.now()}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showToast('Export Complete', 'File downloaded successfully', 'success', 3000);
}

function copyBookToClipboard() {
    if (!currentBookData) return;

    const content = `BOOK: ${currentBookData.title}\n\n\nSUMMARY:\n\n${currentBookData.summary}`;

    navigator.clipboard.writeText(content).then(() => {
        showToast('Copied', 'Book summary copied to clipboard', 'success', 2000);
    }).catch(err => {
        console.error('Copy failed:', err);
        showToast('Copy Failed', 'Failed to copy to clipboard', 'error');
    });
}
</script>
{% endblock %}
