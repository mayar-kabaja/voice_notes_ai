{% extends "base.html" %}

{% block content %}
<!-- Chat History Sidebar -->
<div class="chat-history-sidebar" id="chatHistorySidebar">
    <div class="sidebar-header">
        <h3>Chat History</h3>
        <button class="sidebar-close-btn" onclick="toggleHistorySidebar()">âœ•</button>
    </div>
    <div class="sidebar-actions">
        <button class="btn-new-conversation" onclick="startNewConversation()">
            <span>â•</span>
            <span>New Conversation</span>
        </button>
    </div>
    <div class="sidebar-content">
        <div id="conversationsList" class="conversations-list">
            <div class="loading-conversations">Loading conversations...</div>
        </div>
    </div>
</div>

<!-- Chat Container -->
<div class="chat-container">
    <!-- Chat Header -->
    <div class="chat-header">
        <div class="chat-header-info">
            {% if current_user.is_authenticated %}
                <button class="history-toggle-btn" onclick="toggleHistorySidebar()" title="Chat History">
                    ğŸ“‹
                </button>
            {% endif %}
            <div class="ai-avatar">ğŸ¤–</div>
            <div>
                <h3>NoteFlow AI Assistant</h3>
                <p class="status-text">Online<span style="font-size: 0.85em; font-style: italic; opacity: 0.7;">â€¢ by Mayar</span></p>
            </div>
        </div>
        <div class="chat-header-auth">
            {% if current_user.is_authenticated %}
                <div class="user-info-inline">
                    <span class="user-email">{{ current_user.email }}</span>
                    <button class="btn-logout-inline" onclick="showLogoutModal()">Logout</button>
                </div>
            {% else %}
                <div class="guest-buttons-inline">
                    <button class="btn-login-small" onclick="showLoginModal()">Login</button>
                    <button class="btn-signup-small" onclick="showSignupModal()">Sign Up</button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Chat Messages Area -->
    <div class="chat-messages" id="chatMessages">
        <!-- Welcome Message -->
        <div class="message ai-message">
            <div class="message-avatar">ğŸ¤–</div>
            <div class="message-content">
                <div class="message-bubble">
                    <p>ğŸ‘‹ Hi! I'm your NoteFlow AI assistant.</p>
                    <p>I can help you transform content into structured notes:</p>
                    <ul>
                        <li>ğŸ¤ <strong>Audio recordings</strong> - Record or upload MP3, WAV, M4A</li>
                        <li>ğŸ“š <strong>Books & Documents</strong> - Upload PDF, EPUB, TXT, DOCX</li>
                        <li>ğŸ¬ <strong>Videos</strong> - Upload files or paste YouTube URLs</li>
                    </ul>
                    <p><strong>Just drop a file below or click to browse!</strong> âœ¨</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Input Area -->
    <div class="chat-input-area">
        <form id="chatForm" enctype="multipart/form-data" onsubmit="return false;">
            <!-- Recording Interface (Inline) -->
            <div class="inline-recording" id="inlineRecording" style="display: none;">
                <div class="recording-content">
                    <div class="recording-header">
                        <span class="recording-icon">ğŸ™ï¸</span>
                        <span class="recording-title">Recording...</span>
                        <button type="button" class="close-recording" id="closeInlineRecording">âœ•</button>
                    </div>

                    <div class="recording-body">
                        <div class="recording-timer" id="inlineRecordingTimer">
                            <span class="timer-display" id="inlineTimerDisplay">00:00</span>
                        </div>

                        <div class="recording-controls">
                            <button type="button" class="rec-btn rec-start" id="inlineStartRecordBtn">
                                <span>âº</span>
                                <span>Start</span>
                            </button>
                            <button type="button" class="rec-btn rec-stop" id="inlineStopRecordBtn" style="display: none;">
                                <span>â¹</span>
                                <span>Stop</span>
                            </button>
                        </div>

                        <div class="recording-preview" id="inlineAudioPreview" style="display: none;">
                            <audio controls id="inlineAudioPlayback" class="audio-playback"></audio>
                            <div class="preview-actions">
                                <button type="button" class="rec-btn rec-use" id="inlineUseRecordingBtn">
                                    <span>âœ“</span>
                                    <span>Use Recording</span>
                                </button>
                                <button type="button" class="rec-btn rec-discard" id="inlineDiscardRecordingBtn">
                                    <span>ğŸ—‘ï¸</span>
                                    <span>Discard</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Text Input (Default) -->
            <div class="chat-text-input" id="chatTextInput">
                <!-- Input wrapper with icons inside -->
                <div class="input-wrapper">
                    <!-- Icons inside input (left side) -->
                    <div class="input-icons-inside">
                        <button type="button" class="input-icon-btn" id="recordAudioBtn" title="Record Audio">
                            ğŸ™ï¸
                        </button>
                        <button type="button" class="input-icon-btn" id="uploadFileBtn" title="Upload File">
                            ğŸ“
                        </button>
                        <button type="button" class="input-icon-btn" id="youtubeBtn" title="YouTube URL">
                            ğŸ¬
                        </button>
                    </div>

                    <input type="text" id="userMessageInput" placeholder="Type your message..." class="text-input-field" autocomplete="off">

                    <button type="button" class="send-btn" id="sendMessageBtn" title="Send message">
                        <span>â¤</span>
                    </button>
                </div>
            </div>

            <!-- Hidden File Input (for programmatic file selection) -->
            <input type="file" id="chatFileInput" name="file"
                   accept="audio/*,video/*,.pdf,.epub,.txt,.docx,.doc,.mp3,.wav,.m4a,.ogg,.flac,.webm,.opus,.mp4,.mov,.avi,.mkv"
                   class="file-input" style="display: none;">

            <!-- URL Input for YouTube -->
            <div class="chat-url-input" id="chatUrlInput" style="display: none;">
                <input type="text" id="youtubeUrl" placeholder="ğŸ”— Paste YouTube URL here..." class="url-input-field">
                <button type="button" class="url-submit-btn" id="submitUrl">Send</button>
                <button type="button" class="url-cancel-btn" id="cancelUrl">âœ•</button>
            </div>
        </form>
    </div>
</div>

<!-- Recording Modal (Deprecated - Now using inline recording) -->
<div id="recordingModal" class="modal" style="display: none !important;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>
                <span>ğŸ™ï¸</span>
                <span>Record Audio</span>
            </h2>
            <button class="modal-close" id="closeRecordingModal">
                <span>&times;</span>
            </button>
        </div>
        <div class="modal-body" style="text-align: center;">
            <div class="recording-status" id="recordingStatus">
                <div class="recording-icon-large">ğŸ”´</div>
                <p class="recording-hint-text">Click Record to start</p>
            </div>

            <div class="recording-timer-large" id="recordingTimerLarge" style="display: none;">
                <span class="recording-pulse"></span>
                <span id="timerDisplayLarge" style="font-size: 2.5rem; font-weight: 600; color: var(--primary-color);">00:00</span>
            </div>

            <div class="recording-controls-modal">
                <button type="button" class="btn" id="startRecordBtn">
                    <span>ğŸ™ï¸</span>
                    <span>Start Recording</span>
                </button>
                <button type="button" class="btn btn-secondary" id="stopRecordBtn" style="display: none;">
                    <span>â¹ï¸</span>
                    <span>Stop Recording</span>
                </button>
            </div>

            <div class="audio-preview-modal" id="audioPreviewModal" style="display: none;">
                <p style="margin: 20px 0 10px; font-weight: 600;">Preview:</p>
                <audio id="audioPlaybackModal" controls style="width: 100%; margin-bottom: 20px;"></audio>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button type="button" class="btn" id="useRecordingBtn">
                        <span>âœ…</span>
                        <span>Use Recording</span>
                    </button>
                    <button type="button" class="btn btn-secondary" id="discardRecordingBtn">
                        <span>ğŸ—‘ï¸</span>
                        <span>Discard</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Result Modal (Hidden - Results shown in chat instead) -->
<div id="resultModal" class="modal" style="display: none !important;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>
                <span>âœ…</span>
                <span id="resultModalTitle">Your Notes</span>
            </h2>
            <button class="modal-close" id="closeModal">
                <span>&times;</span>
            </button>
        </div>

        <div class="modal-body">
            <div class="transcript" id="transcriptSection">
                <h3>ğŸ“ Transcript</h3>
                <p id="modalTranscript"></p>
            </div>

            <div class="notes">
                <div class="summary-header">
                    <h3>âœ¨ AI-Generated Summary</h3>
                    <div class="translate-controls">
                        <select id="modalTargetLanguage" class="language-select-inline" onchange="translateModalSummary()">
                            <option value="">ğŸŒ Translate</option>
                            <option value="Spanish">ğŸ‡ªğŸ‡¸ Spanish</option>
                            <option value="French">ğŸ‡«ğŸ‡· French</option>
                            <option value="German">ğŸ‡©ğŸ‡ª German</option>
                            <option value="Arabic">ğŸ‡¸ğŸ‡¦ Arabic</option>
                            <option value="Chinese">ğŸ‡¨ğŸ‡³ Chinese</option>
                            <option value="Japanese">ğŸ‡¯ğŸ‡µ Japanese</option>
                            <option value="Korean">ğŸ‡°ğŸ‡· Korean</option>
                            <option value="Portuguese">ğŸ‡µğŸ‡¹ Portuguese</option>
                            <option value="Russian">ğŸ‡·ğŸ‡º Russian</option>
                            <option value="Italian">ğŸ‡®ğŸ‡¹ Italian</option>
                            <option value="Hindi">ğŸ‡®ğŸ‡³ Hindi</option>
                            <option value="Turkish">ğŸ‡¹ğŸ‡· Turkish</option>
                        </select>
                    </div>
                </div>
                <div id="modalSummary"></div>
            </div>

            <!-- Export Options -->
            <div class="export-options">
                <button class="btn btn-export export-btn" onclick="exportModalAsText()" title="Download summary as a plain text file">
                    <span>ğŸ“¥</span>
                    <span>Export as TXT</span>
                </button>
                <button class="btn btn-export export-btn" onclick="exportModalAsMarkdown()" title="Download summary as a Markdown file">
                    <span>ğŸ“„</span>
                    <span>Export as Markdown</span>
                </button>
                <button class="btn btn-secondary export-btn" onclick="copyModalToClipboard()" title="Copy summary to your clipboard">
                    <span>ğŸ“‹</span>
                    <span>Copy to Clipboard</span>
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn" onclick="closeResultModal()">
                    <span>â¬†</span>
                    <span>Upload Another File</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Error Testing Panel (LOCALHOST ONLY - Hidden by default - Press Ctrl+Shift+T to toggle) -->
<!-- This panel is automatically removed in production (only works on localhost/127.0.0.1) -->
<div id="errorTestPanel" class="error-test-panel" style="display: none;">
    <div>
        <div class="test-panel-header">
            <h3>ğŸ§ª Error Testing Panel</h3>
            <button class="test-panel-close" id="closeTestPanel">âœ•</button>
        </div>
        <div class="test-panel-body">
            <p class="test-panel-hint">Click any button to simulate that error:</p>

            <div class="test-section">
                <h4>ğŸ“ File Upload Errors</h4>
                <button class="test-btn" onclick="testFileRateLimit()">â³ Rate Limit</button>
                <button class="test-btn" onclick="testFileQuota()">ğŸ’³ Quota Exceeded</button>
                <button class="test-btn" onclick="testFileAuth()">ğŸ”‘ Auth Error</button>
                <button class="test-btn" onclick="testFileGeneric()">âŒ Generic Error</button>
            </div>

            <div class="test-section">
                <h4>ğŸ¬ YouTube Errors</h4>
                <button class="test-btn" onclick="testYoutubeRateLimit()">â³ Rate Limit</button>
                <button class="test-btn" onclick="testYoutubeQuota()">ğŸ’³ Quota Exceeded</button>
                <button class="test-btn" onclick="testYoutubeGeneric()">âŒ Generic Error</button>
            </div>

            <div class="test-section">
                <h4>ğŸ’¬ Chat Errors</h4>
                <button class="test-btn" onclick="testChatRateLimit()">â³ Rate Limit</button>
                <button class="test-btn" onclick="testChatQuota()">ğŸ’³ Quota Exceeded</button>
                <button class="test-btn" onclick="testChatGeneric()">âŒ Generic Error</button>
            </div>

            <div class="test-section">
                <h4>ğŸŒ Translation Errors</h4>
                <button class="test-btn" onclick="testTranslationRateLimit()">â³ Rate Limit</button>
                <button class="test-btn" onclick="testTranslationQuota()">ğŸ’³ Quota Exceeded</button>
            </div>
        </div>
        <div class="test-panel-footer">
            <small>Press <kbd>Ctrl+Shift+T</kbd> to toggle â€¢ <kbd>Esc</kbd> to close</small>
        </div>
    </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="auth-modal" style="display: none;">
    <div class="auth-modal-overlay" onclick="closeLoginModal()"></div>
    <div class="auth-modal-content">
        <div class="auth-modal-header">
            <h3>Login to NoteFlow AI</h3>
            <button class="auth-modal-close" onclick="closeLoginModal()">&times;</button>
        </div>
        <form id="loginForm" class="auth-form">
            <div class="auth-modal-body">
                <p class="auth-modal-message" id="loginActionMessage" style="margin-bottom: 20px; display: none;">
                    You need an account to <strong id="loginActionText">use this feature</strong>.
                </p>

                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" name="email" required placeholder="your@email.com" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" name="password" required placeholder="Enter your password" autocomplete="current-password">
                </div>

                <div class="form-group-checkbox">
                    <input type="checkbox" id="loginRemember" name="remember">
                    <label for="loginRemember">Remember me</label>
                </div>

                <div id="loginError" class="form-error" style="display: none;"></div>
            </div>
            <div class="auth-modal-footer">
                <button type="submit" class="btn-modal-primary" id="loginSubmitBtn">
                    <span>Login with Email</span>
                </button>

                <div class="oauth-divider">
                    <span>or continue with</span>
                </div>

                <div class="oauth-buttons-row">
                    <button type="button" class="btn-oauth btn-google" onclick="loginWithGoogle()">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
                            <path d="M9.003 18c2.43 0 4.467-.806 5.956-2.184L12.05 13.56c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9.003 18z" fill="#34A853"/>
                            <path d="M3.964 10.712c-.18-.54-.282-1.117-.282-1.71 0-.593.102-1.17.282-1.71V4.96H.957C.347 6.175 0 7.55 0 9.002c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                            <path d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.426 0 9.003 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29c.708-2.127 2.692-3.71 5.036-3.71z" fill="#EA4335"/>
                        </svg></button>

                    <button type="button" class="btn-oauth btn-github" onclick="loginWithGithub()">
                        <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                        </svg></button></div>

                <p class="auth-modal-switch">
                    Don't have an account? <a href="#" onclick="switchToSignup(); return false;">Sign Up</a>
                </p>
            </div>
        </form>
    </div>
</div>

<!-- Signup Modal -->
<div id="signupModal" class="auth-modal" style="display: none;">
    <div class="auth-modal-overlay" onclick="closeSignupModal()"></div>
    <div class="auth-modal-content">
        <div class="auth-modal-header">
            <h3>Create Your Account</h3>
            <button class="auth-modal-close" onclick="closeSignupModal()">&times;</button>
        </div>
        <form id="signupForm" class="auth-form">
            <div class="auth-modal-body">
                <p class="auth-modal-message" style="margin-bottom: 20px;">
                    Join NoteFlow AI to save your work and access it from anywhere!
                </p>

                <div class="form-group">
                    <label for="signupEmail">Email Address</label>
                    <input type="email" id="signupEmail" name="email" required placeholder="your@email.com" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="signupUsername">Username (Optional)</label>
                    <input type="text" id="signupUsername" name="username" placeholder="Your display name" autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" name="password" required placeholder="At least 8 characters" autocomplete="new-password" minlength="8">
                </div>

                <div class="form-group">
                    <label for="signupConfirmPassword">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" name="confirm_password" required placeholder="Re-enter your password" autocomplete="new-password">
                </div>

                <div id="signupError" class="form-error" style="display: none;"></div>
            </div>
            <div class="auth-modal-footer">
                <button type="submit" class="btn-modal-primary" id="signupSubmitBtn">
                    <span>Sign Up with Email</span>
                </button>

                <div class="oauth-divider">
                    <span>or continue with</span>
                </div>

                <div class="oauth-buttons-row">
                    <button type="button" class="btn-oauth btn-google" onclick="loginWithGoogle()">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
                            <path d="M9.003 18c2.43 0 4.467-.806 5.956-2.184L12.05 13.56c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9.003 18z" fill="#34A853"/>
                            <path d="M3.964 10.712c-.18-.54-.282-1.117-.282-1.71 0-.593.102-1.17.282-1.71V4.96H.957C.347 6.175 0 7.55 0 9.002c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                            <path d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.426 0 9.003 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29c.708-2.127 2.692-3.71 5.036-3.71z" fill="#EA4335"/>
                        </svg></button>

                    <button type="button" class="btn-oauth btn-github" onclick="loginWithGithub()">
                        <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                        </svg></button></div>

                <p class="auth-modal-switch">
                    Already have an account? <a href="#" onclick="switchToLogin(); return false;">Login</a>
                </p>
            </div>
        </form>
    </div>
</div>

<!-- Logout Confirmation Modal -->
<div id="logoutModal" class="auth-modal" style="display: none;">
    <div class="auth-modal-overlay" onclick="closeLogoutModal()"></div>
    <div class="auth-modal-content" style="max-width: 400px;">
        <div class="auth-modal-header">
            <h3>Logout</h3>
            <button class="auth-modal-close" onclick="closeLogoutModal()">&times;</button>
        </div>
        <div class="auth-modal-body">
            <p class="auth-modal-message">Are you sure you want to logout?</p>
            <p class="auth-modal-submessage">You can always log back in anytime.</p>
        </div>
        <div class="auth-modal-footer" style="flex-direction: row; gap: 12px;">
            <button type="button" class="btn-modal-secondary" onclick="closeLogoutModal()" style="flex: 1;">Cancel</button>
            <button type="button" class="btn-modal-danger" onclick="confirmLogout()" style="flex: 1;">Logout</button>
        </div>
    </div>
</div>

<!-- Delete Conversation Confirmation Modal -->
<div id="deleteConversationModal" class="auth-modal" style="display: none;">
    <div class="auth-modal-overlay" onclick="closeDeleteConversationModal()"></div>
    <div class="auth-modal-content" style="max-width: 400px;">
        <div class="auth-modal-header">
            <h3>Delete Conversation</h3>
            <button class="auth-modal-close" onclick="closeDeleteConversationModal()">&times;</button>
        </div>
        <div class="auth-modal-body">
            <p class="auth-modal-message">Are you sure you want to delete this conversation?</p>
            <p class="auth-modal-submessage">This action cannot be undone.</p>
        </div>
        <div class="auth-modal-footer" style="flex-direction: row; gap: 12px;">
            <button type="button" class="btn-modal-secondary" onclick="closeDeleteConversationModal()" style="flex: 1;">Cancel</button>
            <button type="button" class="btn-modal-danger" onclick="confirmDeleteConversation()" style="flex: 1;">Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
// Auth modal functions
function showLoginModal(action = null) {
    const modal = document.getElementById('loginModal');
    const actionMessage = document.getElementById('loginActionMessage');
    const actionText = document.getElementById('loginActionText');

    if (action) {
        actionText.textContent = action;
        actionMessage.style.display = 'block';
    } else {
        actionMessage.style.display = 'none';
    }

    modal.style.display = 'flex';
    document.getElementById('loginEmail').focus();
}

function showSignupModal() {
    const modal = document.getElementById('signupModal');
    modal.style.display = 'flex';
    document.getElementById('signupEmail').focus();
}

function closeLoginModal() {
    const modal = document.getElementById('loginModal');
    modal.style.display = 'none';
    document.getElementById('loginForm').reset();
    document.getElementById('loginError').style.display = 'none';
}

function closeSignupModal() {
    const modal = document.getElementById('signupModal');
    modal.style.display = 'none';
    document.getElementById('signupForm').reset();
    document.getElementById('signupError').style.display = 'none';
}

function switchToSignup() {
    closeLoginModal();
    showSignupModal();
}

function switchToLogin() {
    closeSignupModal();
    showLoginModal();
}

// Handle login form submission
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = document.getElementById('loginSubmitBtn');
    const errorDiv = document.getElementById('loginError');

    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const remember = document.getElementById('loginRemember').checked;

    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.textContent = 'Logging in...';
    errorDiv.style.display = 'none';

    try {
        const response = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, remember })
        });

        const data = await response.json();

        if (data.success) {
            showToast('Welcome back!', data.message, 'success');
            closeLoginModal();
            // Reload page to update UI
            setTimeout(() => window.location.reload(), 500);
        } else {
            errorDiv.textContent = data.message;
            errorDiv.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Login';
        }
    } catch (error) {
        errorDiv.textContent = 'Network error. Please try again.';
        errorDiv.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Login';
    }
});

// Handle signup form submission
document.getElementById('signupForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = document.getElementById('signupSubmitBtn');
    const errorDiv = document.getElementById('signupError');

    const email = document.getElementById('signupEmail').value.trim();
    const username = document.getElementById('signupUsername').value.trim();
    const password = document.getElementById('signupPassword').value;
    const confirm_password = document.getElementById('signupConfirmPassword').value;

    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating account...';
    errorDiv.style.display = 'none';

    try {
        const response = await fetch('/api/signup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, username, password, confirm_password })
        });

        const data = await response.json();

        if (data.success) {
            showToast('Account created!', data.message, 'success');
            closeSignupModal();
            // Reload page to update UI
            setTimeout(() => window.location.reload(), 500);
        } else {
            errorDiv.textContent = data.message;
            errorDiv.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Account';
        }
    } catch (error) {
        errorDiv.textContent = 'Network error. Please try again.';
        errorDiv.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Account';
    }
});

// Close modal when clicking outside or ESC key
window.addEventListener('click', function(event) {
    const loginModal = document.getElementById('loginModal');
    const signupModal = document.getElementById('signupModal');

    if (event.target === loginModal) {
        closeLoginModal();
    }
    if (event.target === signupModal) {
        closeSignupModal();
    }
});

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeLoginModal();
        closeSignupModal();
        closeLogoutModal();
        closeDeleteConversationModal();
    }
});

// Logout confirmation functions
function showLogoutModal() {
    const modal = document.getElementById('logoutModal');
    modal.style.display = 'flex';
}

function closeLogoutModal() {
    const modal = document.getElementById('logoutModal');
    modal.style.display = 'none';
}

function confirmLogout() {
    window.location.href = '{{ url_for("auth.logout") }}';
}

// OAuth functions
function loginWithGoogle() {
    playSound('click');
    window.location.href = '/auth/google';
}

function loginWithGithub() {
    playSound('click');
    window.location.href = '/auth/github';
}

// ============== CHAT HISTORY FUNCTIONALITY ==============

let currentConversationId = null;

// Helper function to add messages (wraps chat.js functions)
function addMessage(content, type) {
    if (type === 'user') {
        addUserMessage(content);
    } else if (type === 'ai') {
        addAIMessage(content);
    }
}

// Toggle chat history sidebar
function toggleHistorySidebar() {
    const sidebar = document.getElementById('chatHistorySidebar');
    const body = document.body;

    if (sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
        body.classList.remove('sidebar-open');
    } else {
        sidebar.classList.add('open');
        body.classList.add('sidebar-open');
        loadConversations();
    }
}

// Update which conversation is marked as active in the sidebar
function updateActiveConversation(conversationId) {
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-conversation-id') == conversationId) {
            item.classList.add('active');
        }
    });
}

// Load all conversations from server
async function loadConversations() {
    const conversationsList = document.getElementById('conversationsList');
    conversationsList.innerHTML = '<div class="loading-conversations">Loading conversations...</div>';

    try {
        const response = await fetch('/api/conversations');
        const conversations = await response.json();

        if (conversations.length === 0) {
            conversationsList.innerHTML = `
                <div class="no-conversations">
                    <div class="no-conversations-icon">ğŸ’¬</div>
                    <p>No conversations yet</p>
                    <p style="font-size: 12px; opacity: 0.7;">Start chatting to create your first conversation!</p>
                </div>
            `;
            return;
        }

        conversationsList.innerHTML = '';
        conversations.forEach(conv => {
            const conversationItem = createConversationItem(conv);
            conversationsList.appendChild(conversationItem);
        });

        // Restore active conversation highlighting if there is one
        if (currentConversationId) {
            updateActiveConversation(currentConversationId);
        }
    } catch (error) {
        conversationsList.innerHTML = '<div class="loading-conversations">Failed to load conversations</div>';
        console.error('Error loading conversations:', error);
    }
}

// Create conversation item HTML element
function createConversationItem(conversation) {
    const item = document.createElement('div');
    item.className = 'conversation-item';
    if (currentConversationId === conversation.id) {
        item.classList.add('active');
    }
    item.setAttribute('data-conversation-id', conversation.id);

    const date = new Date(conversation.updated_at);
    const formattedDate = formatDate(date);

    item.innerHTML = `
        <div class="conversation-title">${conversation.title}</div>
        <div class="conversation-meta">
            <span class="conversation-date">${formattedDate}</span>
            <span class="conversation-messages-count">${conversation.message_count} messages</span>
        </div>
        <div class="conversation-actions">
            <button class="conversation-action-btn" onclick="deleteConversation(${conversation.id}, event)" title="Delete">
                ğŸ—‘ï¸
            </button>
        </div>
    `;

    item.addEventListener('click', (e) => {
        if (!e.target.classList.contains('conversation-action-btn')) {
            loadConversation(conversation.id);
        }
    });

    return item;
}

// Format date for display
function formatDate(date) {
    const now = new Date();
    const diff = now - date;
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (days > 7) {
        return date.toLocaleDateString();
    } else if (days > 0) {
        return `${days}d ago`;
    } else if (hours > 0) {
        return `${hours}h ago`;
    } else if (minutes > 0) {
        return `${minutes}m ago`;
    } else {
        return 'Just now';
    }
}

// Load specific conversation
async function loadConversation(conversationId) {
    try {
        const response = await fetch(`/api/conversation/${conversationId}`);
        const conversation = await response.json();

        // Clear current chat messages
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';

        // Reset message counter and count loaded messages
        if (typeof currentMessageCount !== 'undefined') {
            currentMessageCount = conversation.messages.length;
        }

        // Display conversation messages
        conversation.messages.forEach(msg => {
            if (msg.role === 'user') {
                addMessage(msg.content, 'user');
            } else {
                addMessage(msg.content, 'ai');
            }
        });

        // Set current conversation ID
        currentConversationId = conversationId;

        // Update UI to show active conversation
        updateActiveConversation(conversationId);

        // Close sidebar on mobile
        if (window.innerWidth < 768) {
            toggleHistorySidebar();
        }

    } catch (error) {
        console.error('Error loading conversation:', error);
        showToast('Error', 'Failed to load conversation', 'error');
    }
}

// Store conversation ID to delete
let conversationIdToDelete = null;

// Delete conversation (show confirmation modal)
function deleteConversation(conversationId, event) {
    event.stopPropagation();
    conversationIdToDelete = conversationId;
    document.getElementById('deleteConversationModal').style.display = 'flex';
}

// Close delete conversation modal
function closeDeleteConversationModal() {
    document.getElementById('deleteConversationModal').style.display = 'none';
    conversationIdToDelete = null;
}

// Confirm delete conversation
async function confirmDeleteConversation() {
    if (!conversationIdToDelete) return;

    const conversationId = conversationIdToDelete;
    closeDeleteConversationModal();

    try {
        const response = await fetch(`/api/conversation/${conversationId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            // If deleted conversation was current, clear chat
            if (currentConversationId === conversationId) {
                startNewConversation();
            }

            // Reload conversations list
            loadConversations();
            showToast('Deleted', 'Conversation deleted successfully', 'success');
        } else {
            showToast('Error', data.message, 'error');
        }
    } catch (error) {
        console.error('Error deleting conversation:', error);
        showToast('Error', 'Failed to delete conversation', 'error');
    }
}

// Start new conversation (clear current)
function startNewConversation() {
    currentConversationId = null;

    // Reset message counter
    if (typeof currentMessageCount !== 'undefined') {
        currentMessageCount = 0;
    }

    // Clear current context
    if (typeof currentContext !== 'undefined') {
        currentContext = {
            type: null,
            id: null,
            data: null
        };
    }

    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';

    // Show welcome message
    const welcomeDiv = document.createElement('div');
    welcomeDiv.className = 'message ai-message';
    welcomeDiv.innerHTML = `
        <div class="message-avatar">ğŸ¤–</div>
        <div class="message-content">
            <div class="message-bubble">
                <p>ğŸ‘‹ Hi! I'm your NoteFlow AI assistant.</p>
                <p>I can help you transform content into structured notes:</p>
                <ul>
                    <li>ğŸ¤ <strong>Audio recordings</strong> - Record or upload MP3, WAV, M4A</li>
                    <li>ğŸ“š <strong>Books & Documents</strong> - Upload PDF, EPUB, TXT, DOCX</li>
                    <li>ğŸ¬ <strong>Videos</strong> - Upload files or paste YouTube URLs</li>
                </ul>
                <p><strong>Just drop a file below or click to browse!</strong> âœ¨</p>
            </div>
        </div>
    `;
    chatMessages.appendChild(welcomeDiv);

    // Update UI
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
    });

    // Close sidebar on mobile
    if (window.innerWidth < 768) {
        const sidebar = document.getElementById('chatHistorySidebar');
        if (sidebar.classList.contains('open')) {
            toggleHistorySidebar();
        }
    }
}

</script>
{% endblock %}
